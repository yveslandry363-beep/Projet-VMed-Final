apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: gemini-consumer-scaler
  namespace: default # Assurez-vous que cela correspond au namespace de votre d√©ploiement
spec:
  scaleTargetRef:
    name: gemini-consumer-deployment # üéØ Cible le d√©ploiement que nous avons cr√©√© √† la Phase 3
  
  # --- R√®gles de Scaling ---
  minReplicaCount: 1          # Toujours au moins 1 pod en cours d'ex√©cution
  maxReplicaCount: 100        # Peut monter jusqu'√† 100 pods sous forte charge
  pollingInterval: 30         # KEDA v√©rifie le lag toutes les 30 secondes
  cooldownPeriod:  300        # Attend 5 minutes (300s) d'inactivit√© avant de redescendre √† 0 (si minReplicaCount=0)

  triggers:
  - type: kafka
    metadata:
      # IMPORTANT: Doit pointer vers le service Kafka DANS le cluster Kubernetes
      # Ce n'est PAS l'adresse Aiven externe.
      bootstrapServers: kafka-service.default.svc.cluster.local:9092
      
      # Le topic et le groupe de consommateurs √† surveiller
      topic: pg_diagnostics.public.diagnostics
      consumerGroup: gemini-processor-group-RESET-3 # Doit correspondre EXACTEMENT au GroupId dans appsettings.json
      
      # Le seuil de d√©clenchement du scaling
      lagThreshold: "20" # Si le lag (nombre de messages non lus) d√©passe 20, KEDA commence √† cr√©er de nouveaux pods.
      
      # --- Authentification (si n√©cessaire dans K8s) ---
      # Si votre Kafka dans K8s n√©cessite une authentification, on la configure ici.
      # Par exemple, pour SASL :
      # authenticationMode: sasl_ssl
      # username: "user-secret" # Fait r√©f√©rence √† un TriggerAuthentication
      # password: "password-secret"